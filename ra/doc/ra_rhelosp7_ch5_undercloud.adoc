[chapter 5]
== Install the undercloud
This section lists the steps that were followed to install and
configure OSP 7 with OSP-d in the Red Hat Systems Engineering lab.

=== Prepare the undercloud server

1. Install the operating system.
+
[source%autofit, shell]
----
# cat /etc/redhat-release
Red Hat Enterprise Linux Server release 7.1 (Maipo)
----
+
2. Set the hostname
+
[source%autofit, shell]
----
# hostnamectl set-hostname rhos0.osplocal
# hostnamectl set-hostname --transient rhos0.osplocal
# export HOSTNAME=rhos0.osplocal
# hostname
rhos0.osplocal
----
+
3. Register the system with *subscription-manager*.
+
[source%autofit, shell]
----
# subscription-manager register --org syseng --activationkey OSP7-undercloud
The system has been registered with ID:
84e0fb33-24b0-4a1d-968e-e80352daa4f6 
Installed Product Current Status:
Product Name: Red Hat Enterprise Linux Server
Status:       Subscribed
----
+
4. List active repositories.
+
[source%autofit, shell]
----
# yum repolist
Loaded plugins: langpacks, product-id, rhnplugin, subscription-manager
This system is receiving updates from RHN Classic or Red Hat
Satellite.
repo id                                                         repo name status
!rhel-7-server-extras-rpms/x86_64                               Red Hat Enterprise Linux 7 Server - Extras (RPMs) 89
!rhel-7-server-openstack-7.0-rpms/7Server/x86_64                Red Hat OpenStack 7.0 for RHEL 7 (RPMs) 497
!rhel-7-server-optional-rpms/7Server/x86_64                     Red Hat Enterprise Linux 7 Server - Optional (RPMs) 5,674
!rhel-7-server-rpms/7Server/x86_64                              Red Hat Enterprise Linux 7 Server (RPMs) 7,392
rhel-x86_64-server-7                                            Red Hat Enterprise Linux Server (v. 7 for 64-bit x86_64) 7,424
repolist: 21,076
----
+
// link to required channels
+
5. Create the stack user
+
[source%autofit, shell]
----
# useradd stack
# echo 'stack:password' | chpasswd
# echo "stack ALL=(root) NOPASSWD:ALL" | tee -a
/etc/sudoers.d/stack
stack ALL=(root) NOPASSWD:ALL
# chmod 0440 /etc/sudoers.d/stack
# id stack
uid=1000(stack) gid=1000(stack) groups=1000(stack)
----

=== Deploy the Control Plane
1. Switch to the stack user account.
+
[source%autofit, shell]
----
# su - stack
$ id
uid=1000(stack) gid=1000(stack) groups=1000(stack) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
----
+
2. Install the OpenStack director plugin.
+
[source%autofit, shell]
----
$ sudo yum install -y -q python-rdomanager-oscplugin
$ sudo rpm -q python-rdomanager-oscplugin
python-rdomanager-oscplugin-0.0.8-44.el7ost.noarch
----
+
3. Create the _undercloud.conf_. This file contains
  configuration data for the undercloud installation.
+
[source%autofit, ruby, numbered]
----
  [DEFAULT]

  image_path = .
  local_ip = 192.0.2.1/24
  local_interface = eno4
  masquerade_network = 192.0.2.0/24
  dhcp_start = 192.0.2.5
  dhcp_end = 192.0.2.24
  network_cidr = 192.0.2.0/24
  network_gateway = 192.0.2.1
  discovery_interface = br-ctlplane
  discovery_iprange = 192.0.2.100,192.0.2.120
  discovery_runbench = false
  undercloud_debug = true

  [auth]

  undercloud_db_password =
  undercloud_admin_token =
  undercloud_admin_password =
  undercloud_glance_password =
  undercloud_heat_encryption_key =
  undercloud_heat_password =
  undercloud_neutron_password =
  undercloud_nova_password =
  undercloud_ironic_password =
  undercloud_tuskar_password =
  undercloud_ceilometer_password =
  undercloud_ceilometer_metering_secret =
  undercloud_ceilometer_snmpd_user =
  undercloud_ceilometer_snmpd_password =
  undercloud_swift_password =
  undercloud_rabbit_cookie =
  undercloud_rabbit_password =
  undercloud_rabbit_username =
  undercloud_heat_stack_domain_admin_password =
  undercloud_swift_hash_suffix =
----
+
*eno4* is the provisioning network interface. Blank passwords are
auto-generated by the installer. Accept *br-ctlplane* as the default
discovery interface.
+
NOTE: Installing with SSL support is beyond the scope of this
reference architecture.
+
4. Install the undercloud.
+
[source%autofit, shell]
----
$ openstack undercloud install | tee uc.out 2>&1
...
#############################################################################
instack-install-undercloud complete.

The file containing this installation's passwords is at
/home/stack/undercloud-passwords.conf.

There is also a stackrc file at /home/stack/stackrc.

These files are needed to interact with the OpenStack services, and should be
secured.
#############################################################################
----
+
5. Source _stackrc_ to set environment variables for interacting with the undercloud.
+
[source%autofit, shell]
----
$ source stackrc 
$ env | grep OS_
OS_PASSWORD=7f1dbeead29fe7b1ca96fcf4bec20efb1717f6db
OS_AUTH_URL=http://192.0.2.1:5000/v2.0
OS_USERNAME=admin
OS_TENANT_NAME=admin
OS_NO_CACHE=True
----
+
6. Verify all services are active.
+
[source%autofit, shell]
----
$ openstack-service status
neutron-dhcp-agent (pid 16458) is active
neutron-openvswitch-agent (pid 17750) is active
neutron-server (pid 16517) is active
openstack-ceilometer-alarm-evaluator (pid 16101) is active
openstack-ceilometer-alarm-notifier (pid 16033) is active
openstack-ceilometer-api (pid 16068) is active
openstack-ceilometer-central (pid 15998) is active
openstack-ceilometer-collector (pid 15965) is active
openstack-ceilometer-notification (pid 15932) is active
openstack-glance-api (pid 16984) is active
openstack-glance-registry (pid 16915) is active
openstack-heat-api-cfn (pid 17783) is active
openstack-heat-api-cloudwatch (pid 17959) is active
openstack-heat-api (pid 17886) is active
openstack-heat-engine (pid 17818) is active
openstack-ironic-api (pid 14485) is active
openstack-ironic-conductor (pid 19038) is active
openstack-ironic-discoverd-dnsmasq (pid 19953) is active
openstack-ironic-discoverd (pid 19959) is active
openstack-keystone (pid 16636) is active
openstack-nova-api (pid 17129) is active
openstack-nova-compute (pid 19831) is active
openstack-nova-conductor (pid 17319) is active
openstack-nova-consoleauth (pid 17087) is active
openstack-nova-scheduler (pid 17279) is active
openstack-swift-account-auditor (pid 15378) is active
openstack-swift-account-reaper (pid 15349) is active
openstack-swift-account-replicator (pid 15725) is active
openstack-swift-account (pid 15758) is active
openstack-swift-container-auditor (pid 15486) is active
openstack-swift-container-replicator (pid 15822) is active
openstack-swift-container-updater (pid 16429) is active
openstack-swift-container (pid 15851) is active
openstack-swift-object-auditor (pid 15590) is active
openstack-swift-object-replicator (pid 16288) is active
openstack-swift-object-updater (pid 15619) is active
openstack-swift-object (pid 16255) is active
openstack-swift-proxy (pid 16155) is active
openstack-tuskar-api (pid 19994) is active
----
+
7. Increase the maximum database connections.
+
[source%autofit, shell]
----
$ sudo sed -i 's/max_connections =.*$/max_connections = 4096/' /etc/my.cnf.d/server.cnf
$ sudo grep max_connections /etc/my.cnf.d/server.cnf max_connections = 4096
$ sudo mysql -e "SET GLOBAL max_connections = 4096"
$ sudo mysql -e "SHOW GLOBAL VARIABLES LIKE 'max_connections'"
+-----------------+-------+
| Variable_name   | Value |
+-----------------+-------+
| max_connections | 4096  |
+-----------------+-------+
----
+
8. Increase or disable Neutron port quotas.
+
[source%autofit, shell]
----
$ neutron quota-update --port -1
+---------------------+-------+
| Field               | Value |
+---------------------+-------+
| network             | 10    |
| port                | -1    |
| security_group      | 10    |
| security_group_rule | 100   |
| subnet              | 10    |
+---------------------+-------+
$ neutron quota-show
+---------------------+-------+
| Field               | Value |
+---------------------+-------+
| network             | 10    |
| port                | -1    |
| security_group      | 10    |
| security_group_rule | 100   |
| subnet              | 10    |
+---------------------+-------+
----
+
9. Increase the RPC response timeout for Ironic and Neutron to 600 if
  they are not already set.
+
[source%autofit, shell]
----
$ sudo openstack-config --set /etc/nova/nova.conf DEFAULT rpc_response_timeout 600
$ sudo openstack-config --set /etc/ironic/ironic.conf DEFAULT rpc_response_timeout 600
$ sudo openstack-service restart nova
$ sudo openstack-service restart ironic
$ sudo openstack-service status | grep -E 'ironic|nova'
openstack-ironic-api (pid 22864) is active
openstack-ironic-conductor (pid 22873) is active
openstack-ironic-discoverd-dnsmasq (pid 22867) is active
openstack-ironic-discoverd (pid 22863) is active
openstack-nova-api (pid 22584) is active
openstack-nova-compute (pid 22586) is active
openstack-nova-conductor (pid 22601) is active
openstack-nova-consoleauth (pid 22605) is active
openstack-nova-scheduler (pid 22600) is active
$ sudo openstack-config --get /etc/nova/nova.conf DEFAULT rpc_response_timeout
600
$ sudo openstack-config --get /etc/ironic/ironic.conf DEFAULT rpc_response_timeout
600
----

<<<

